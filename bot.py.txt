import discord
from discord.ext import commands
from datetime import datetime
import json
import os

# ========== CONFIG ==========
TOKEN = os.getenv("TOKEN")  # il token viene letto da Render (Environment Variable)

# ID CANALI (tuoi)
ID_ORDINI_FORNITORI   = 1437442516017479750  # #ordini-da-fare-ai-fornitori
ID_MAGAZZINO          = 1437442556551233536  # #merce-in-arrivo-o-in-magazzino
ID_SPEDIZIONI         = 1437442600716992634  # #spedizioni-e-ritiri-clienti
ID_COMPLETATI         = 1437442636620234812  # #ordini-completati
ID_PROBLEMI           = 1437442673316335728  # #anomalie-e-problemi

DATAFILE = "ordini.json"
# ============================

intents = discord.Intents.default()
intents.message_content = True  # attivalo anche nel Developer Portal
bot = commands.Bot(command_prefix="/", intents=intents)

STATI = {
    "ğŸ†•": "ğŸ†• Da inviare al fornitore",
    "ğŸ“¤": "ğŸ“¤ Inviato al fornitore",
    "ğŸ“¦": "ğŸ“¦ Arrivato in magazzino",
    "ğŸšš": "ğŸšš Spedito / Pronto al ritiro",
    "âœ…": "âœ… Completato (consegnato/ritirato)",
    "âš ï¸": "âš ï¸ Anomalia",
    "âŒ": "âŒ Problema/Annullato"
}

FASE_TO_CHANNEL = {
    "ğŸ†•": ID_ORDINI_FORNITORI,
    "ğŸ“¤": ID_ORDINI_FORNITORI,
    "ğŸ“¦": ID_MAGAZZINO,
    "ğŸšš": ID_SPEDIZIONI,
    "âœ…": ID_COMPLETATI,
    "âš ï¸": ID_PROBLEMI,
    "âŒ": ID_PROBLEMI
}

def checklist_per(emoji: str) -> str:
    if emoji == "ğŸ†•":
        return ("- [ ] Da inviare al fornitore\n"
                "- [ ] Inviato al fornitore\n"
                "- [ ] Arrivato in magazzino\n"
                "- [ ] Spedito / Pronto al ritiro\n"
                "- [ ] Completato")
    if emoji == "ğŸ“¤":
        return ("- [x] Da inviare al fornitore\n"
                "- [x] Inviato al fornitore\n"
                "- [ ] Arrivato in magazzino\n"
                "- [ ] Spedito / Pronto al ritiro\n"
                "- [ ] Completato")
    if emoji == "ğŸ“¦":
        return ("- [x] Da inviare al fornitore\n"
                "- [x] Inviato al fornitore\n"
                "- [x] Arrivato in magazzino\n"
                "- [ ] Spedito / Pronto al ritiro\n"
                "- [ ] Completato")
    if emoji == "ğŸšš":
        return ("- [x] Da inviare al fornitore\n"
                "- [x] Inviato al fornitore\n"
                "- [x] Arrivato in magazzino\n"
                "- [x] Spedito / Pronto al ritiro\n"
                "- [ ] Completato")
    if emoji == "âœ…":
        return ("- [x] Da inviare al fornitore\n"
                "- [x] Inviato al fornitore\n"
                "- [x] Arrivato in magazzino\n"
                "- [x] Spedito / Pronto al ritiro\n"
                "- [x] Completato")
    if emoji == "âš ï¸":
        return ("- [x] Da inviare al fornitore\n"
                "âš ï¸ Problema rilevato (in lavorazione)")
    if emoji == "âŒ":
        return ("âŒ Ordine annullato / non evaso")
    return ""

def ora_it():
    return datetime.now().strftime("%d/%m/%Y %H:%M")

def load_db():
    if not os.path.exists(DATAFILE):
        return {}
    with open(DATAFILE, "r", encoding="utf-8") as f:
        try:
            return json.load(f)
        except Exception:
            return {}

def save_db(db):
    with open(DATAFILE, "w", encoding="utf-8") as f:
        json.dump(db, f, ensure_ascii=False, indent=2)

db = load_db()

def is_order_message(content: str) -> bool:
    return content and "**Checklist:**" in content

def render(order_id: str, dettagli: str, stato_emoji: str) -> str:
    return (
        f"{stato_emoji} **{order_id}**\n"
        f"{dettagli}\n\n"
        f"**Stato attuale:** {STATI[stato_emoji]}\n"
        f"**Checklist:**\n{checklist_per(stato_emoji)}\n\n"
        f"_Ultimo aggiornamento: {ora_it()}_"
    )

async def ensure_copy_in_phase_channel(order_id: str, dettagli: str, stato_emoji: str) -> dict:
    channel_id = FASE_TO_CHANNEL[stato_emoji]
    channel = bot.get_channel(channel_id) or await bot.fetch_channel(channel_id)

    record = db.get(order_id, {"stato": "ğŸ†•", "messages": [], "dettagli": dettagli})
    target_msg_id = None
    for m in record["messages"]:
        if m["channel_id"] == channel_id:
            target_msg_id = m["message_id"]
            break

    content = render(order_id, dettagli, stato_emoji)

    if target_msg_id:
        try:
            msg = await channel.fetch_message(target_msg_id)
            await msg.edit(content=content)
        except Exception:
            msg = await channel.send(content)
    else:
        msg = await channel.send(content)

    for e in ["ğŸ“¤", "ğŸ“¦", "ğŸšš", "âœ…", "âš ï¸", "âŒ"]:
        try:
            await msg.add_reaction(e)
        except Exception:
            pass

    updated = False
    for m in record["messages"]:
        if m["channel_id"] == channel_id:
            m["message_id"] = msg.id
            updated = True
            break
    if not updated:
        record["messages"].append({"channel_id": channel_id, "message_id": msg.id})

    record["stato"] = stato_emoji
    record["dettagli"] = dettagli
    db[order_id] = record
    save_db(db)
    return record

async def upd
